--liquibase formatted sql
--changeset ${vr_owner_user}_CODE:VIEW_VW_AGE runOnChange:TRUE  failOnError:TRUE splitStatements:TRUE


  CREATE OR REPLACE FORCE VIEW "VW_AGE" ("ASOFDATE", "SOURCE_SYSTEM_ID", "INSTRUMENT_ID", "INSTRUMENT_TYPE", "BOOK_ID", "PRICE", "QUANTITY", "FACTOR", "FX_CURRENCY_ID", "NOTIONAL_CURRENCY_ID", "MARKET_VALUE", "MARKET_VALUE_USD", "LONG_SHORT", "PRODUCT_TYPE", "LEGAL_ENTITY_ID", "B0TO30_QTY", "B31TO60_QTY", "B61TO90_QTY", "B91TO180_QTY", "B181TO360_QTY", "B361_QTY", "B0TO30_MV", "B31TO60_MV", "B61TO90_MV", "B91TO180_MV", "B181TO360_MV", "B361_MV", "INSTRUMENT_ID_LEVEL2", "INSTRUMENT_TYPE_LEVEL2", "INSTRUMENT_ID_LEVEL3", "INSTRUMENT_TYPE_LEVEL3", "INSTRUMENT_ID_LEVEL4", "INSTRUMENT_TYPE_LEVEL4", "INSTRUMENT_ID_LEVEL5", "INSTRUMENT_TYPE_LEVEL5", "EXEC_MP_FLG", "EXEC_CA_FLG", "EXEC_DB_FGL", "CLEAN_PRICE", "CLEAN_MARKET_VALUE", "ACCRUED_INTEREST", "HAS_CP_FLG", "HAS_CMV_FLG", "HAS_AI_FLG", "INSTRUMENT_DESCRIPTION", "CHRG_ID", "CHRG_B0TO30", "CHRG_B31TO60", "CHRG_B61TO90", "CHRG_B91TO180", "CHRG_B181TO360", "CHRG_B361", "EXMP_ID", "EXMP_B0TO30", "EXMP_B31TO60", "EXMP_B61TO90", "EXMP_B91TO180", "EXMP_B181TO360", "EXMP_B361", "FINAL_B0TO30", "FINAL_B31TO60", "FINAL_B61TO90", "FINAL_B91TO180", "FINAL_B181TO360", "FINAL_B361", "ORPHAN_FLG", "DUPLICATED_FLG", "CHARGE_THRESHOLD_FLG", "NUM_TRADES", "QV_INSTRUMENT_ID", "NOTIONAL", "DELTA", "PV01", "DV01", "RISK_RATIO", "NPV_PL", "MTM_PV", "ASSET_LIABILITY", "CONTRACT_SIZE", "UNDERLYING", "UNDERLYING_CCY", "SPOT_PRICE", "STRIKE_PRICE", "INSTRUMENT_ID_UNDERLYING", "EXPIRY_MATURITY_DATE", "RISK_INFORMATION_FLG", "PRODUCT_ID", "RATES_INFORMATION_FLG", "NUM_DAYS_0_30", "NUM_DAYS_31_60", "NUM_DAYS_61_90", "NUM_DAYS_91_180", "NUM_DAYS_181_360", "NUM_DAYS_361", "FX_RATE") AS 
  SELECT leg.ASOFDATE,
  leg.SOURCE_SYSTEM_ID,
  leg.INSTRUMENT_ID,
  leg.INSTRUMENT_TYPE,
  leg.BOOK_ID,
  leg.PRICE,
  leg.QUANTITY,
  leg.FACTOR,
  leg.FX_CURRENCY_ID,
  leg.NOTIONAL_CURRENCY_ID,
  leg.MARKET_VALUE,
  leg.MARKET_VALUE_USD,
  leg.LONG_SHORT,
  leg.PRODUCT_TYPE,
  leg.LEGAL_ENTITY_ID,
  leg.B0TO30_QTY,
  leg.B31TO60_QTY,
  leg.B61TO90_QTY,

  leg.B91TO180_QTY,
  leg.B181TO360_QTY,
  leg.B361_QTY,
  leg.B0TO30_MV,
  leg.B31TO60_MV,
  leg.B61TO90_MV,
  leg.B91TO180_MV,
  leg.B181TO360_MV,
  leg.B361_MV,
  leg.INSTRUMENT_ID_LEVEL2,
  leg.INSTRUMENT_TYPE_LEVEL2,
  leg.INSTRUMENT_ID_LEVEL3,
  leg.INSTRUMENT_TYPE_LEVEL3,
  leg.INSTRUMENT_ID_LEVEL4,
  leg.INSTRUMENT_TYPE_LEVEL4,
  leg.INSTRUMENT_ID_LEVEL5,
  leg.INSTRUMENT_TYPE_LEVEL5,
  leg.EXEC_MP_FLG,
  leg.EXEC_CA_FLG,
  leg.EXEC_DB_FGL,
  leg.CLEAN_PRICE,
  leg.CLEAN_MARKET_VALUE,
  leg.ACCRUED_INTEREST,
  leg.HAS_CP_FLG,
  leg.HAS_CMV_FLG,
  leg.HAS_AI_FLG,
  leg.INSTRUMENT_DESCRIPTION,
  leg.CHRG_ID,
  leg.CHRG_B0TO30,
  leg.CHRG_B31TO60,
  leg.CHRG_B61TO90,
  leg.CHRG_B91TO180,
  leg.CHRG_B181TO360,
  leg.CHRG_B361,
  leg.EXMP_ID,
  leg.EXMP_B0TO30,
  leg.EXMP_B31TO60,
  leg.EXMP_B61TO90,
  leg.EXMP_B91TO180,
  leg.EXMP_B181TO360,
  leg.EXMP_B361,
  leg.FINAL_B0TO30,
  leg.FINAL_B31TO60,
  leg.FINAL_B61TO90,
  leg.FINAL_B91TO180,
  leg.FINAL_B181TO360,
  leg.FINAL_B361,
  leg.ORPHAN_FLG,
  leg.DUPLICATED_FLG,
  leg.CHARGE_THRESHOLD_FLG,
  leg.NUM_TRADES,
  leg.QV_INSTRUMENT_ID,
  leg.NOTIONAL,
  leg.DELTA,
  leg.PV01,
  leg.DV01,
  leg.RISK_RATIO,
  leg.NPV_PL,
  leg.MTM_PV,
  leg.ASSET_LIABILITY,
  leg.CONTRACT_SIZE,
  leg.UNDERLYING,
  leg.UNDERLYING_CCY,
  leg.SPOT_PRICE,
  leg.STRIKE_PRICE,
  leg.INSTRUMENT_ID_UNDERLYING,
  leg.EXPIRY_MATURITY_DATE,
  leg.RISK_INFORMATION_FLG,
  leg.PRODUCT_ID,
  leg.RATES_INFORMATION_FLG,
  leg.NUM_DAYS_0_30,
  leg.NUM_DAYS_31_60,
  leg.NUM_DAYS_61_90,
  leg.NUM_DAYS_91_180,
  leg.NUM_DAYS_181_360,
  leg.NUM_DAYS_361,
  leg.FX_RATE
FROM age leg
INNER JOIN paraLlel_config c
ON leg.source_system_id=c.source_system_id
AND c.metric_id        ='IA'
AND c.origin           ='LEGACY'
AND c.cobdate          =
  (SELECT MAX(b.cobdate) FROM parallel_config b WHERE b.cobdate<=leg.asofdate and b.METRIC_ID='IA' and b.SOURCE_SYSTEM_ID=leg.SOURCE_SYSTEM_ID  )
UNION ALL
SELECT refact.ASOFDATE,
  refact.SOURCE_SYSTEM_ID,

  refact.INSTRUMENT_ID,
  refact.INSTRUMENT_TYPE,
  refact.BOOK_ID,
  refact.PRICE,
  refact.QUANTITY,
  refact.FACTOR,
  refact.FX_CURRENCY_ID,
  refact.NOTIONAL_CURRENCY_ID,
  refact.MARKET_VALUE,
  refact.MARKET_VALUE_USD,
  refact.LONG_SHORT,
  refact.PRODUCT_TYPE,
  refact.LEGAL_ENTITY_ID,
  refact.B0TO30_QTY,
  refact.B31TO60_QTY,
  refact.B61TO90_QTY,
  refact.B91TO180_QTY,
  refact.B181TO360_QTY,
  refact.B361_QTY,
  refact.B0TO30_MV,
  refact.B31TO60_MV,
  refact.B61TO90_MV,
  refact.B91TO180_MV,
  refact.B181TO360_MV,
  refact.B361_MV,
  refact.INSTRUMENT_ID_LEVEL2,
  refact.INSTRUMENT_TYPE_LEVEL2,
  refact.INSTRUMENT_ID_LEVEL3,
  refact.INSTRUMENT_TYPE_LEVEL3,
  refact.INSTRUMENT_ID_LEVEL4,
  refact.INSTRUMENT_TYPE_LEVEL4,
  refact.INSTRUMENT_ID_LEVEL5,
  refact.INSTRUMENT_TYPE_LEVEL5,
  refact.EXEC_MP_FLG,
  refact.EXEC_CA_FLG,
  refact.EXEC_DB_FGL,
  refact.CLEAN_PRICE,
  refact.CLEAN_MARKET_VALUE,
  refact.ACCRUED_INTEREST,
  refact.HAS_CP_FLG,
  refact.HAS_CMV_FLG,
  refact.HAS_AI_FLG,
  refact.INSTRUMENT_DESCRIPTION,
  refact.CHRG_ID,
  refact.CHRG_B0TO30,
  refact.CHRG_B31TO60,
  refact.CHRG_B61TO90,
  refact.CHRG_B91TO180,
  refact.CHRG_B181TO360,
  refact.CHRG_B361,
  refact.EXMP_ID,
  refact.EXMP_B0TO30,
  refact.EXMP_B31TO60,
  refact.EXMP_B61TO90,
  refact.EXMP_B91TO180,
  refact.EXMP_B181TO360,
  refact.EXMP_B361,
  refact.FINAL_B0TO30,
  refact.FINAL_B31TO60,
  refact.FINAL_B61TO90,
  refact.FINAL_B91TO180,
  refact.FINAL_B181TO360,
  refact.FINAL_B361,
  refact.ORPHAN_FLG,
  refact.DUPLICATED_FLG,
  refact.CHARGE_THRESHOLD_FLG,
  refact.NUM_TRADES,
  refact.QV_INSTRUMENT_ID,
  refact.NOTIONAL,
  refact.DELTA,
  refact.PV01,
  refact.DV01,
  refact.RISK_RATIO,
  refact.NPV_PL,
  refact.MTM_PV,
  refact.ASSET_LIABILITY,
  refact.CONTRACT_SIZE,
  refact.UNDERLYING,
  refact.UNDERLYING_CCY,
  refact.SPOT_PRICE,
  refact.STRIKE_PRICE,
  refact.INSTRUMENT_ID_UNDERLYING,
  refact.EXPIRY_MATURITY_DATE,
  refact.RISK_INFORMATION_FLG,

  refact.PRODUCT_ID,
  refact.RATES_INFORMATION_FLG,
  refact.NUM_DAYS_0_30,
  refact.NUM_DAYS_31_60,
  refact.NUM_DAYS_61_90,
  refact.NUM_DAYS_91_180,
  refact.NUM_DAYS_181_360,
  refact.NUM_DAYS_361,

  refact.FX_RATE
FROM new_Age refact
INNER JOIN paraLlel_config c
ON refact.source_system_id=c.source_system_id
AND c.metric_id           ='IA'
AND c.origin              ='REFACTORING'
AND c.cobdate             =
    (SELECT MAX(b.cobdate) FROM parallel_config b WHERE b.cobdate<=refact.asofdate and b.METRIC_ID='IA' and b.SOURCE_SYSTEM_ID=refact.SOURCE_SYSTEM_ID  );
