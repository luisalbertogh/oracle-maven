--liquibase formatted sql
--changeset ${vr_owner_user}_CODE:PACKAGE_PKG_BH_UPDATER runOnChange:TRUE  failOnError:TRUE splitStatements:FALSE


  CREATE OR REPLACE PACKAGE "PKG_BH_UPDATER" AS 

  /**************************************************************************************************************
  * Autor: SERGIO.REDONDO@DB.COM
  * Date: 24/03/2015
  *
  * Purpose: This package manage all the related functions or procedures directly related to book hierarchy updater


  FUNCTION F_GENERATE_COPY_BH			--> Function to generate a copy of the newest version of the BH with a new date
  FUNCTION F_PROCESS_INSERT			--> Function to check if a source_system-book_id pair already exist in the BH
  
  
  ***************************************************************************************************************/
  -----------------------------------------------------------------------------
  -- Functionality: Generate a copy of the newest version of the BH with a new date
  -- Used: Book hierarchy updater
  ------------------------------------------------------------------------------
                
  FUNCTION F_GENERATE_COPY_BH(new_date book_hierarchy_rpl.asofdate%TYPE) RETURN NUMBER;
  
    -----------------------------------------------------------------------------
    -- Functionality: Process an insert line for the new BH
    -- Used: Book hierarchy updater
    ------------------------------------------------------------------------------
                
  FUNCTION F_PROCESS_INSERT(as_of_date book_hierarchy_rpl.ASOFDATE%TYPE, bookid book_hierarchy_rpl.BOOK_ID%TYPE, volckertradingdesk book_hierarchy_rpl.VOLCKER_TRADING_DESK%TYPE, volckertradingdeskfull book_hierarchy_rpl.VOLCKER_TRADING_DESK_FULL%TYPE, lowestlevelrplcode book_hierarchy_rpl.LOWEST_LEVEL_RPL_CODE%TYPE, lowestlevelrplfullname book_hierarchy_rpl.LOWEST_LEVEL_RPL_FULL_NAME%TYPE, lowestlevelrpl book_hierarchy_rpl.LOWEST_LEVEL_RPL%TYPE, sourcesystem book_hierarchy_rpl.SOURCE_SYSTEM%TYPE, legalentity book_hierarchy_rpl.LEGAL_ENTITY%TYPE, globaltraderbookid book_hierarchy_rpl.GLOBAL_TRADER_BOOK_ID%TYPE, profitcenterid book_hierarchy_rpl.PROFIT_CENTER_ID%TYPE, comments book_hierarchy_rpl.COMMENTS%TYPE, datasource book_hierarchy_rpl.DATA_SOURCE%TYPE, chargereportingunitcode book_hierarchy_rpl.CHARGE_REPORTING_UNIT_CODE%TYPE, chargereportingunit book_hierarchy_rpl.CHARGE_REPORTING_UNIT%TYPE, chargereportingparentcode book_hierarchy_rpl.CHARGE_REPORTING_PARENT_CODE%TYPE, chargereportingparent book_hierarchy_rpl.CHARGE_REPORTING_PARENT%TYPE, milocation book_hierarchy_rpl.MI_LOCATION%TYPE, ubrlevel1id book_hierarchy_rpl.UBR_LEVEL_1_ID%TYPE, ubrlevel1name book_hierarchy_rpl.UBR_LEVEL_1_NAME%TYPE, ubrlevel1rplcode book_hierarchy_rpl.UBR_LEVEL_1_RPL_CODE%TYPE, ubrlevel2id book_hierarchy_rpl.UBR_LEVEL_2_ID%TYPE, ubrlevel2name book_hierarchy_rpl.UBR_LEVEL_2_NAME%TYPE, ubrlevel2rplcode book_hierarchy_rpl.UBR_LEVEL_2_RPL_CODE%TYPE, ubrlevel3id book_hierarchy_rpl.UBR_LEVEL_3_ID%TYPE, ubrlevel3name book_hierarchy_rpl.UBR_LEVEL_3_NAME%TYPE, ubrlevel3rplcode book_hierarchy_rpl.UBR_LEVEL_3_RPL_CODE%TYPE, ubrlevel4id book_hierarchy_rpl.UBR_LEVEL_4_ID%TYPE, ubrlevel4name book_hierarchy_rpl.UBR_LEVEL_4_NAME%TYPE, ubrlevel4rplcode book_hierarchy_rpl.UBR_LEVEL_4_RPL_CODE%TYPE, ubrlevel5id book_hierarchy_rpl.UBR_LEVEL_5_ID%TYPE, ubrlevel5name book_hierarchy_rpl.UBR_LEVEL_5_NAME%TYPE, ubrlevel5rplcode book_hierarchy_rpl.UBR_LEVEL_5_RPL_CODE%TYPE, ubrlevel6id book_hierarchy_rpl.UBR_LEVEL_6_ID%TYPE, ubrlevel6name book_hierarchy_rpl.UBR_LEVEL_6_NAME%TYPE, ubrlevel6rplcode book_hierarchy_rpl.UBR_LEVEL_6_RPL_CODE%TYPE, ubrlevel7id book_hierarchy_rpl.UBR_LEVEL_7_ID%TYPE, ubrlevel7name book_hierarchy_rpl.UBR_LEVEL_7_NAME%TYPE, ubrlevel7rplcode book_hierarchy_rpl.UBR_LEVEL_7_RPL_CODE%TYPE, ubrlevel8id book_hierarchy_rpl.UBR_LEVEL_8_ID%TYPE, ubrlevel8name book_hierarchy_rpl.UBR_LEVEL_8_NAME%TYPE, ubrlevel8rplcode book_hierarchy_rpl.UBR_LEVEL_8_RPL_CODE%TYPE, ubrlevel9id book_hierarchy_rpl.UBR_LEVEL_9_ID%TYPE, ubrlevel9name book_hierarchy_rpl.UBR_LEVEL_9_NAME%TYPE, ubrlevel9rplcode book_hierarchy_rpl.UBR_LEVEL_9_RPL_CODE%TYPE, ubrlevel10id book_hierarchy_rpl.UBR_LEVEL_10_ID%TYPE, ubrlevel10name book_hierarchy_rpl.UBR_LEVEL_10_NAME%TYPE, ubrlevel10rplcode book_hierarchy_rpl.UBR_LEVEL_10_RPL_CODE%TYPE, ubrlevel11id book_hierarchy_rpl.UBR_LEVEL_11_ID%TYPE, ubrlevel11name book_hierarchy_rpl.UBR_LEVEL_11_NAME%TYPE, ubrlevel11rplcode book_hierarchy_rpl.UBR_LEVEL_11_RPL_CODE%TYPE, ubrlevel12id book_hierarchy_rpl.UBR_LEVEL_12_ID%TYPE, ubrlevel12name book_hierarchy_rpl.UBR_LEVEL_12_NAME%TYPE, ubrlevel12rplcode book_hierarchy_rpl.UBR_LEVEL_12_RPL_CODE%TYPE, ubrlevel13id book_hierarchy_rpl.UBR_LEVEL_13_ID%TYPE, ubrlevel13name book_hierarchy_rpl.UBR_LEVEL_13_NAME%TYPE, ubrlevel13rplcode book_hierarchy_rpl.UBR_LEVEL_13_RPL_CODE%TYPE, ubrlevel14id book_hierarchy_rpl.UBR_LEVEL_14_ID%TYPE, ubrlevel14name book_hierarchy_rpl.UBR_LEVEL_14_NAME%TYPE, ubrlevel14rplcode book_hierarchy_rpl.UBR_LEVEL_14_RPL_CODE%TYPE, desklevel1id book_hierarchy_rpl.DESK_LEVEL_1_ID%TYPE, desklevel1name book_hierarchy_rpl.DESK_LEVEL_1_NAME%TYPE, desklevel1rplcode book_hierarchy_rpl.DESK_LEVEL_1_RPL_CODE%TYPE, desklevel2id book_hierarchy_rpl.DESK_LEVEL_2_ID%TYPE, desklevel2name book_hierarchy_rpl.DESK_LEVEL_2_NAME%TYPE, desklevel2rplcode book_hierarchy_rpl.DESK_LEVEL_2_RPL_CODE%TYPE, desklevel3id book_hierarchy_rpl.DESK_LEVEL_3_ID%TYPE, desklevel3name book_hierarchy_rpl.DESK_LEVEL_3_NAME%TYPE, desklevel3rplcode book_hierarchy_rpl.DESK_LEVEL_3_RPL_CODE%TYPE, desklevel4id book_hierarchy_rpl.DESK_LEVEL_4_ID%TYPE, desklevel4name book_hierarchy_rpl.DESK_LEVEL_4_NAME%TYPE, desklevel4rplcode book_hierarchy_rpl.DESK_LEVEL_4_RPL_CODE%TYPE, desklevel5id book_hierarchy_rpl.DESK_LEVEL_5_ID%TYPE, desklevel5name book_hierarchy_rpl.DESK_LEVEL_5_NAME%TYPE, desklevel5rplcode book_hierarchy_rpl.DESK_LEVEL_5_RPL_CODE%TYPE, portfolioid book_hierarchy_rpl.PORTFOLIO_ID%TYPE, portfolioname book_hierarchy_rpl.PORTFOLIO_NAME%TYPE, portfoliorplcode book_hierarchy_rpl.PORTFOLIO_RPL_CODE%TYPE, business book_hierarchy_rpl.BUSINESS%TYPE, subbusiness book_hierarchy_rpl.SUB_BUSINESS%TYPE, region book_hierarchy_rpl.REGION%TYPE, subregion book_hierarchy_rpl.SUBREGION%TYPE) RETURN NUMBER;
  
    -----------------------------------------------------------------------------
    -- Functionality: Process an update line for the new BH
    -- Used: Book hierarchy updater
    ------------------------------------------------------------------------------
                
  FUNCTION F_PROCESS_UPDATE(volckertradingdeskold book_hierarchy_rpl.VOLCKER_TRADING_DESK%TYPE, sourcesystemold book_hierarchy_rpl.SOURCE_SYSTEM%TYPE ,as_of_date book_hierarchy_rpl.ASOFDATE%TYPE, bookid book_hierarchy_rpl.BOOK_ID%TYPE, volckertradingdesk book_hierarchy_rpl.VOLCKER_TRADING_DESK%TYPE, volckertradingdeskfull book_hierarchy_rpl.VOLCKER_TRADING_DESK_FULL%TYPE, lowestlevelrplcode book_hierarchy_rpl.LOWEST_LEVEL_RPL_CODE%TYPE, lowestlevelrplfullname book_hierarchy_rpl.LOWEST_LEVEL_RPL_FULL_NAME%TYPE, lowestlevelrpl book_hierarchy_rpl.LOWEST_LEVEL_RPL%TYPE, sourcesystem book_hierarchy_rpl.SOURCE_SYSTEM%TYPE, legalentity book_hierarchy_rpl.LEGAL_ENTITY%TYPE, globaltraderbookid book_hierarchy_rpl.GLOBAL_TRADER_BOOK_ID%TYPE, profitcenterid book_hierarchy_rpl.PROFIT_CENTER_ID%TYPE, comments_ book_hierarchy_rpl.COMMENTS%TYPE, datasource book_hierarchy_rpl.DATA_SOURCE%TYPE, chargereportingunitcode book_hierarchy_rpl.CHARGE_REPORTING_UNIT_CODE%TYPE, chargereportingunit book_hierarchy_rpl.CHARGE_REPORTING_UNIT%TYPE, chargereportingparentcode book_hierarchy_rpl.CHARGE_REPORTING_PARENT_CODE%TYPE, chargereportingparent book_hierarchy_rpl.CHARGE_REPORTING_PARENT%TYPE, milocation book_hierarchy_rpl.MI_LOCATION%TYPE, ubrlevel1id book_hierarchy_rpl.UBR_LEVEL_1_ID%TYPE, ubrlevel1name book_hierarchy_rpl.UBR_LEVEL_1_NAME%TYPE, ubrlevel1rplcode book_hierarchy_rpl.UBR_LEVEL_1_RPL_CODE%TYPE, ubrlevel2id book_hierarchy_rpl.UBR_LEVEL_2_ID%TYPE, ubrlevel2name book_hierarchy_rpl.UBR_LEVEL_2_NAME%TYPE, ubrlevel2rplcode book_hierarchy_rpl.UBR_LEVEL_2_RPL_CODE%TYPE, ubrlevel3id book_hierarchy_rpl.UBR_LEVEL_3_ID%TYPE, ubrlevel3name book_hierarchy_rpl.UBR_LEVEL_3_NAME%TYPE, ubrlevel3rplcode book_hierarchy_rpl.UBR_LEVEL_3_RPL_CODE%TYPE, ubrlevel4id book_hierarchy_rpl.UBR_LEVEL_4_ID%TYPE, ubrlevel4name book_hierarchy_rpl.UBR_LEVEL_4_NAME%TYPE, ubrlevel4rplcode book_hierarchy_rpl.UBR_LEVEL_4_RPL_CODE%TYPE, ubrlevel5id book_hierarchy_rpl.UBR_LEVEL_5_ID%TYPE, ubrlevel5name book_hierarchy_rpl.UBR_LEVEL_5_NAME%TYPE, ubrlevel5rplcode book_hierarchy_rpl.UBR_LEVEL_5_RPL_CODE%TYPE, ubrlevel6id book_hierarchy_rpl.UBR_LEVEL_6_ID%TYPE, ubrlevel6name book_hierarchy_rpl.UBR_LEVEL_6_NAME%TYPE, ubrlevel6rplcode book_hierarchy_rpl.UBR_LEVEL_6_RPL_CODE%TYPE, ubrlevel7id book_hierarchy_rpl.UBR_LEVEL_7_ID%TYPE, ubrlevel7name book_hierarchy_rpl.UBR_LEVEL_7_NAME%TYPE, ubrlevel7rplcode book_hierarchy_rpl.UBR_LEVEL_7_RPL_CODE%TYPE, ubrlevel8id book_hierarchy_rpl.UBR_LEVEL_8_ID%TYPE, ubrlevel8name book_hierarchy_rpl.UBR_LEVEL_8_NAME%TYPE, ubrlevel8rplcode book_hierarchy_rpl.UBR_LEVEL_8_RPL_CODE%TYPE, ubrlevel9id book_hierarchy_rpl.UBR_LEVEL_9_ID%TYPE, ubrlevel9name book_hierarchy_rpl.UBR_LEVEL_9_NAME%TYPE, ubrlevel9rplcode book_hierarchy_rpl.UBR_LEVEL_9_RPL_CODE%TYPE, ubrlevel10id book_hierarchy_rpl.UBR_LEVEL_10_ID%TYPE, ubrlevel10name book_hierarchy_rpl.UBR_LEVEL_10_NAME%TYPE, ubrlevel10rplcode book_hierarchy_rpl.UBR_LEVEL_10_RPL_CODE%TYPE, ubrlevel11id book_hierarchy_rpl.UBR_LEVEL_11_ID%TYPE, ubrlevel11name book_hierarchy_rpl.UBR_LEVEL_11_NAME%TYPE, ubrlevel11rplcode book_hierarchy_rpl.UBR_LEVEL_11_RPL_CODE%TYPE, ubrlevel12id book_hierarchy_rpl.UBR_LEVEL_12_ID%TYPE, ubrlevel12name book_hierarchy_rpl.UBR_LEVEL_12_NAME%TYPE, ubrlevel12rplcode book_hierarchy_rpl.UBR_LEVEL_12_RPL_CODE%TYPE, ubrlevel13id book_hierarchy_rpl.UBR_LEVEL_13_ID%TYPE, ubrlevel13name book_hierarchy_rpl.UBR_LEVEL_13_NAME%TYPE, ubrlevel13rplcode book_hierarchy_rpl.UBR_LEVEL_13_RPL_CODE%TYPE, ubrlevel14id book_hierarchy_rpl.UBR_LEVEL_14_ID%TYPE, ubrlevel14name book_hierarchy_rpl.UBR_LEVEL_14_NAME%TYPE, ubrlevel14rplcode book_hierarchy_rpl.UBR_LEVEL_14_RPL_CODE%TYPE, desklevel1id book_hierarchy_rpl.DESK_LEVEL_1_ID%TYPE, desklevel1name book_hierarchy_rpl.DESK_LEVEL_1_NAME%TYPE, desklevel1rplcode book_hierarchy_rpl.DESK_LEVEL_1_RPL_CODE%TYPE, desklevel2id book_hierarchy_rpl.DESK_LEVEL_2_ID%TYPE, desklevel2name book_hierarchy_rpl.DESK_LEVEL_2_NAME%TYPE, desklevel2rplcode book_hierarchy_rpl.DESK_LEVEL_2_RPL_CODE%TYPE, desklevel3id book_hierarchy_rpl.DESK_LEVEL_3_ID%TYPE, desklevel3name book_hierarchy_rpl.DESK_LEVEL_3_NAME%TYPE, desklevel3rplcode book_hierarchy_rpl.DESK_LEVEL_3_RPL_CODE%TYPE, desklevel4id book_hierarchy_rpl.DESK_LEVEL_4_ID%TYPE, desklevel4name book_hierarchy_rpl.DESK_LEVEL_4_NAME%TYPE, desklevel4rplcode book_hierarchy_rpl.DESK_LEVEL_4_RPL_CODE%TYPE, desklevel5id book_hierarchy_rpl.DESK_LEVEL_5_ID%TYPE, desklevel5name book_hierarchy_rpl.DESK_LEVEL_5_NAME%TYPE, desklevel5rplcode book_hierarchy_rpl.DESK_LEVEL_5_RPL_CODE%TYPE, portfolioid book_hierarchy_rpl.PORTFOLIO_ID%TYPE, portfolioname book_hierarchy_rpl.PORTFOLIO_NAME%TYPE, portfoliorplcode book_hierarchy_rpl.PORTFOLIO_RPL_CODE%TYPE, business_ book_hierarchy_rpl.BUSINESS%TYPE, subbusiness book_hierarchy_rpl.SUB_BUSINESS%TYPE, region_ book_hierarchy_rpl.REGION%TYPE, subregion_ book_hierarchy_rpl.SUBREGION%TYPE) RETURN NUMBER;
  
    -----------------------------------------------------------------------------
    -- Functionality: Process a delete line for the new BH
    -- Used: Book hierarchy updater
    ------------------------------------------------------------------------------
                
  FUNCTION F_PROCESS_DELETE(volckertradingdeskold book_hierarchy_rpl.VOLCKER_TRADING_DESK%TYPE, sourcesystemold book_hierarchy_rpl.SOURCE_SYSTEM%TYPE ,as_of_date book_hierarchy_rpl.ASOFDATE%TYPE, bookid book_hierarchy_rpl.BOOK_ID%TYPE) RETURN NUMBER;
  
  -- check if there are BH reloads that should be set as done as being in execution for more than one day
  function CLEAR_UNFINISHED_BH_RELOADS(DESTINY IN VARCHAR2) return number;
  
END PKG_BH_UPDATER;
